#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# Fail fast
set -e

# Debug
# set -x

# Parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
BUILDPACK_DIR=`cd $(dirname $0); cd ..; pwd`

DD_CONFD_DIR="$BUILD_DIR/.apt/etc/datadog-agent/conf.d"

print "Copy custom intergation configs"
mkdir -p $DD_CONFD_DIR
cp -rf $BUILDPACK_DIR/extra/conf.d/* $DD_CONFD_DIR

print "Copy and setup env_var_fetcher script"
cp $BUILDPACK_DIR/bin/env_var_fetcher.py $BUILD_DIR/.apt/etc/datadog-agent
echo "secret_backend_command: python ~/.apt/etc/datadog-agent/env_var_fetcher.py" >> $BUILD_DIR/.apt/etc/datadog-agent/datadog.yaml
